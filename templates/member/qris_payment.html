{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="card-title mb-0">
                        <i class="fas fa-qrcode me-2"></i>Pembayaran QRIS
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- QR Code Section -->
                        <div class="col-md-6 text-center">
                            <h5 class="mb-3">Scan QR Code</h5>
                            <div id="qrcode" class="mb-3"></div>
                            <div class="alert alert-info">
                                <strong>Jumlah:</strong> {{ qr_data.formatted_amount }}
                            </div>
                        </div>
                        
                        <!-- Instructions Section -->
                        <div class="col-md-6">
                            <h5 class="mb-3">Cara Pembayaran</h5>
                            <ol class="list-group list-group-numbered">
                                {% for instruction in qr_data.instructions %}
                                <li class="list-group-item">{{ instruction }}</li>
                                {% endfor %}
                            </ol>
                            
                            <div class="mt-3">
                                <div class="alert alert-warning">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Timeout:</strong> Pembayaran akan expired dalam <span id="countdown">15:00</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Section -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div id="payment-status" class="alert alert-warning text-center">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <strong>Status:</strong> Menunggu pembayaran...
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button id="check-payment" class="btn btn-primary me-2">
                                <i class="fas fa-sync-alt me-2"></i>Cek Pembayaran
                            </button>
                            <a href="{{ url_for('main.cancel_qris_payment', topup_id=topup_id) }}" 
                               class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Batal
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Payment Tips -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Tips Pembayaran
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-mobile-alt fa-2x text-primary mb-2"></i>
                                <p><strong>Mobile Banking</strong><br>
                                Gunakan aplikasi mobile banking yang mendukung QRIS</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-wallet fa-2x text-success mb-2"></i>
                                <p><strong>E-Wallet</strong><br>
                                OVO, GoPay, DANA, LinkAja, ShopeePay</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-shield-alt fa-2x text-info mb-2"></i>
                                <p><strong>Aman</strong><br>
                                Pembayaran dilindungi sistem keamanan bank</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include QR Code Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>

<script>
// Generate QR Code
document.addEventListener('DOMContentLoaded', function() {
    const qrString = "{{ qr_data.qr_string }}";
    const qrcodeDiv = document.getElementById('qrcode');
    
    // Always use Google Charts API as primary method (most reliable)
    generateGoogleChartsQR();
    
    function generateGoogleChartsQR() {
        // Using Google Charts API - most reliable method
        const qrSize = '250x250';
        const qrImg = document.createElement('img');
        qrImg.src = `https://chart.googleapis.com/chart?chs=${qrSize}&cht=qr&chl=${encodeURIComponent(qrString)}`;
        qrImg.alt = 'QRIS QR Code';
        qrImg.style.maxWidth = '100%';
        qrImg.style.height = 'auto';
        qrImg.style.border = '2px solid #dee2e6';
        qrImg.style.borderRadius = '8px';
        qrImg.style.display = 'block';
        qrImg.style.margin = '0 auto';
        
        qrImg.onload = function() {
            console.log('QR Code loaded successfully via Google Charts');
        };
        
        qrImg.onerror = function() {
            console.error('Google Charts QR generation failed, trying alternative');
            tryAlternativeQR();
        };
        
        qrcodeDiv.innerHTML = '';
        qrcodeDiv.appendChild(qrImg);
    }
    
    function tryAlternativeQR() {
        // Method 3: Using QR Server API
        const qrImg = document.createElement('img');
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrString)}`;
        qrImg.alt = 'QRIS QR Code';
        qrImg.style.maxWidth = '100%';
        qrImg.style.height = 'auto';
        qrImg.style.border = '2px solid #dee2e6';
        qrImg.style.borderRadius = '8px';
        qrImg.style.display = 'block';
        qrImg.style.margin = '0 auto';
        
        qrImg.onerror = function() {
            // Final fallback: Show QR string with better formatting
            showQRStringFallback();
        };
        
        qrcodeDiv.innerHTML = '';
        qrcodeDiv.appendChild(qrImg);
    }
    
    function showQRStringFallback() {
        qrcodeDiv.innerHTML = `
            <div class="alert alert-warning text-center">
                <h6><i class="fas fa-exclamation-triangle"></i> QR Code Tidak Dapat Ditampilkan</h6>
                <p>Gunakan aplikasi pemindai QR atau copy string di bawah:</p>
                <div class="mt-3">
                    <button class="btn btn-primary btn-sm" onclick="copyQRString()">
                        <i class="fas fa-copy"></i> Copy QRIS String
                    </button>
                </div>
                <textarea id="qrStringText" class="form-control mt-2" readonly style="height: 80px; font-size: 10px; display: none;">${qrString}</textarea>
                <button class="btn btn-outline-secondary btn-sm mt-2" onclick="toggleQRString()">
                    <i class="fas fa-eye"></i> Show/Hide String
                </button>
            </div>
        `;
    }
    
    function copyQRString() {
        const qrString = "{{ qr_data.qr_string }}";
        navigator.clipboard.writeText(qrString).then(function() {
            alert('QRIS string berhasil dicopy!');
        }).catch(function() {
            document.getElementById('qrStringText').style.display = 'block';
            document.getElementById('qrStringText').select();
        });
    }
    
    function toggleQRString() {
        const textarea = document.getElementById('qrStringText');
        if (textarea.style.display === 'none') {
            textarea.style.display = 'block';
        } else {
            textarea.style.display = 'none';
        }
    }
});

// Payment checking functionality
let checkInterval;
let timeoutInterval;
let timeLeft = 15 * 60; // 15 minutes in seconds

function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('countdown').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft <= 0) {
        clearInterval(timeoutInterval);
        clearInterval(checkInterval);
        document.getElementById('payment-status').innerHTML = 
            '<i class="fas fa-times-circle me-2"></i><strong>Status:</strong> Pembayaran expired';
        document.getElementById('payment-status').className = 'alert alert-danger text-center';
        document.getElementById('check-payment').disabled = true;
    }
    timeLeft--;
}

function checkPaymentStatus() {
    fetch(`{{ url_for('main.check_qris_payment', topup_id=topup_id) }}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.status === 'completed') {
                clearInterval(checkInterval);
                clearInterval(timeoutInterval);
                
                document.getElementById('payment-status').innerHTML = 
                    '<i class="fas fa-check-circle me-2"></i><strong>Status:</strong> Pembayaran berhasil!';
                document.getElementById('payment-status').className = 'alert alert-success text-center';
                
                // Show success message
                if (data.message) {
                    const successAlert = document.createElement('div');
                    successAlert.className = 'alert alert-success mt-3';
                    successAlert.innerHTML = `<i class="fas fa-check me-2"></i>${data.message}`;
                    document.getElementById('payment-status').parentNode.appendChild(successAlert);
                }
                
                // Redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 3000);
                
            } else if (data.success === false && data.error) {
                document.getElementById('payment-status').innerHTML = 
                    `<i class="fas fa-exclamation-triangle me-2"></i><strong>Error:</strong> ${data.error}`;
                document.getElementById('payment-status').className = 'alert alert-danger text-center';
            }
        })
        .catch(error => {
            console.error('Payment check failed:', error);
        });
}

// Manual check button
document.getElementById('check-payment').addEventListener('click', function() {
    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Mengecek...';
    
    checkPaymentStatus();
    
    setTimeout(() => {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Cek Pembayaran';
    }, 2000);
});

// Start automatic checking and countdown
document.addEventListener('DOMContentLoaded', function() {
    // Update countdown immediately and then every second
    updateCountdown();
    timeoutInterval = setInterval(updateCountdown, 1000);
    
    // Check payment status every 10 seconds
    checkInterval = setInterval(checkPaymentStatus, 10000);
    
    // Initial check after 5 seconds
    setTimeout(checkPaymentStatus, 5000);
});

// Clean up intervals when page is unloaded
window.addEventListener('beforeunload', function() {
    if (checkInterval) clearInterval(checkInterval);
    if (timeoutInterval) clearInterval(timeoutInterval);
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.card-header {
    border-bottom: none;
}

#qrcode canvas {
    border: 2px solid #dee2e6;
    border-radius: 8px;
}

.list-group-numbered {
    counter-reset: section;
}

.list-group-numbered .list-group-item {
    border: 1px solid #dee2e6;
    margin-bottom: 5px;
    border-radius: 5px;
}

.list-group-numbered .list-group-item::before {
    counter-increment: section;
    content: counter(section);
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--bs-primary);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
}

.list-group-numbered .list-group-item {
    padding-left: 40px;
}

@media (max-width: 768px) {
    #qrcode canvas {
        width: 200px !important;
        height: 200px !important;
    }
}
</style>
{% endblock %}